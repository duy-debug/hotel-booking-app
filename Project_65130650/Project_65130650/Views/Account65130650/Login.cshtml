@model Project_65130650.Models.Forms.LoginForm65130650

@* Modal Đăng nhập hiển thị dưới dạng popup *@
<div id="loginModal" class="auth-modal is-hidden" aria-hidden="true" role="dialog" aria-labelledby="loginModalTitle">
    <div class="auth-modal_backdrop" data-modal-close></div>
    <div class="auth-modal_panel" style="max-width: 480px;">
        @* Nút đóng Modal *@
        <button type="button" class="auth-modal_close" aria-label="Đóng" data-modal-close>
            <i class="fas fa-times"></i>
        </button>

        <div class="auth-card white-bg">
            @* Tiêu đề Modal *@
            <div class="auth-card_header" style="margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">
                <div class="auth-card_logo">
                    <i class="fas fa-hotel"></i>
                </div>
                <div>
                    <h1 id="loginModalTitle">Đăng Nhập</h1>
                    <p>Đăng nhập để tiếp tục trải nghiệm dịch vụ</p>
                </div>
            </div>

            @* Container hiển thị thông báo lỗi từ Server *@
            <div id="loginErrorContainer" class="auth-validation">
                <ul id="loginErrorList"></ul>
            </div>

            @* Hiển thị thông báo khi đổi mật khẩu thành công (chỉ hiện khi chuyển hướng từ trang Reset) *@
            @if (TempData["PasswordResetSuccess"] != null)
            {
                <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-xl mb-6 flex items-center gap-3">
                    <i class="fas fa-check-circle"></i>
                    <span>@TempData["PasswordResetSuccess"]</span>
                </div>
            }

            <form id="loginForm" class="auth-form">
                @Html.AntiForgeryToken()

                @* Ô nhập Email *@
                <div class="form-group">
                    <label>Email đăng nhập <span style="color: red;">*</span></label>
                    <div class="input-wrapper">
                        @Html.TextBoxFor(m => m.Email, new { @class = "form-control", placeholder = "example@email.com", id = "loginEmail" })
                        <i class="fas fa-envelope input-icon"></i>
                    </div>
                    <span class="field-validation-error" id="loginEmailError"></span>
                </div>

                @* Ô nhập Mật khẩu *@
                <div class="form-group">
                    <label>Mật khẩu <span style="color: red;">*</span></label>
                    <div class="input-wrapper">
                        @Html.PasswordFor(m => m.MatKhau, new { @class = "form-control", placeholder = "Nhập mật khẩu", id = "loginPassword" })
                        <i class="fas fa-lock input-icon"></i>
                    </div>
                    <span class="field-validation-error" id="loginPasswordError"></span>
                </div>

                @* Các tùy chọn Ghi nhớ và Quên mật khẩu *@
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 13px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        @Html.CheckBoxFor(m => m.RememberMe, new { id = "rememberMe" })
                        <span>Ghi nhớ mật khẩu trên máy tính</span>
                    </label>
                    <a href="@Url.Action("ForgotPassword", "Account65130650")" style="color: #0d4ea6; text-decoration: none; font-weight: 500;">Quên mật khẩu?</a>
                </div>

                @* Hộp CAPTCHA *@
                <div class="form-group">
                    <label>Mã xác nhận <span style="color: red;">*</span></label>
                    <div style="display: flex; gap: 10px; align-items: stretch;">
                        <div class="input-wrapper" style="flex: 1; margin-bottom: 0;">
                            @Html.TextBoxFor(m => m.Captcha, new { @class = "form-control", placeholder = "Nhập mã", id = "loginCaptcha" })
                            <i class="fas fa-shield-alt input-icon"></i>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; height: 45px; cursor: pointer;" title="Làm mới mã">
                            <img src="@Url.Action("GetCaptchaImage", "Account65130650")" id="loginCaptchaImage" style="height: 100%; display: block;" onclick="refreshCaptcha('loginCaptchaImage')" />
                        </div>
                    </div>
                    <span class="field-validation-error" id="loginCaptchaError"></span>
                </div>

                <button type="submit" class="btn-primary" id="loginSubmitBtn" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Đăng Nhập
                </button>
            </form>

            @* Chuyển sang Modal đăng ký *@
            <div style="text-align: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid #f1f5f9; font-size: 14px;">
                Chưa có tài khoản?
                <button type="button" class="link-button" data-open-modal="register">Đăng ký ngay</button>
            </div>
        </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Khởi tạo các biến truy xuất DOM
        var loginForm = document.getElementById('loginForm');
        var errorContainer = document.getElementById('loginErrorContainer');
        var errorList = document.getElementById('loginErrorList');
        var submitBtn = document.getElementById('loginSubmitBtn');
        var emailInput = document.getElementById('loginEmail');
        var passwordInput = document.getElementById('loginPassword');
        var rememberCheckbox = document.getElementById('rememberMe');
        var captchaInput = document.getElementById('loginCaptcha');

        // Hàm làm mới CAPTCHA
        window.refreshCaptcha = function(imgId) {
            var img = document.getElementById(imgId);
            img.src = '@Url.Action("GetCaptchaImage", "Account65130650")?' + new Date().getTime();
        };

        /**
         * TỰ ĐỘNG ĐIỀN THÔNG TIN NẾU ĐÃ CHỌN GHI NHỚ TRƯỚC ĐÓ
         * Sử dụng localStorage để lưu trữ tạm thời trên trình duyệt
         */
        try {
            var savedEmail = localStorage.getItem('remembered_email');
            var savedPassword = localStorage.getItem('remembered_password');
            if (savedEmail && savedPassword) {
                emailInput.value = savedEmail;
                passwordInput.value = savedPassword;
                rememberCheckbox.checked = true;
            }
        } catch (e) {
            console.warn('Không thể tải thông tin đăng nhập đã ghi nhớ', e);
        }

        if (loginForm) {
            // Sự kiện submit form
            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Dọn sạch các thông báo lỗi cũ
                errorContainer.style.display = 'none';
                errorList.innerHTML = '';
                document.getElementById('loginEmailError').textContent = '';
                document.getElementById('loginPasswordError').textContent = '';
                document.getElementById('loginCaptchaError').textContent = '';

                // Lấy dữ liệu từ các input
                var email = emailInput.value.trim();
                var password = passwordInput.value;
                var rememberMe = rememberCheckbox.checked;
                var captcha = captchaInput.value.trim();

                // Validate dữ liệu tại Client (Client-side validation)
                var hasError = false;
                if (!email) {
                    document.getElementById('loginEmailError').textContent = 'Vui lòng nhập Email';
                    hasError = true;
                }
                if (!password) {
                    document.getElementById('loginPasswordError').textContent = 'Vui lòng nhập Mật khẩu';
                    hasError = true;
                }
                if (!captcha) {
                    document.getElementById('loginCaptchaError').textContent = 'Vui lòng nhập mã CAPTCHA';
                    hasError = true;
                }
                if (hasError) return;

                /**
                 * XỬ LÝ LƯU TRỮ GHI NHỚ MẬT KHẨU
                 */
                try {
                    if (rememberMe) {
                        localStorage.setItem('remembered_email', email);
                        localStorage.setItem('remembered_password', password);
                    } else {
                        localStorage.removeItem('remembered_email');
                        localStorage.removeItem('remembered_password');
                    }
                } catch (e) {
                    console.warn('Không thể lưu thông tin đăng nhập', e);
                }

                // Hiển thị trạng thái đang xử lý trên nút
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xác thực...';

                // Lấy Token chống giả mạo request (CSRF Protection)
                var tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                var token = tokenElement ? tokenElement.value : '';

                // Gửi thông tin đăng nhập bằng AJAX để không phải load lại trang
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '@Url.Action("LoginAjax", "Account65130650")', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        // Khôi phục trạng thái nút sau khi có phản hồi
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Đăng Nhập';

                        if (xhr.status === 200) {
                            try {
                                var response = JSON.parse(xhr.responseText);
                                if (response.success) {
                                    // Đăng nhập thành công - thực hiện chuyển hướng
                                    window.location.href = response.redirectUrl;
                                } else {
                                    // Đăng nhập thất bại - Hiển thị danh sách lỗi trả về từ Server
                                    errorContainer.style.display = 'block';
                                    if (response.errors && response.errors.length > 0) {
                                        response.errors.forEach(function (err) {
                                            var li = document.createElement('li');
                                            li.textContent = err;
                                            errorList.appendChild(li);
                                         });
                                     }
                                     // Làm mới CAPTCHA khi sai
                                     refreshCaptcha('loginCaptchaImage');
                                     captchaInput.value = '';
                                 }
                             } catch (ex) {
                                errorContainer.style.display = 'block';
                                var li = document.createElement('li');
                                li.textContent = 'Lỗi hệ thống khi xử lý dữ liệu';
                                errorList.appendChild(li);
                            }
                        } else {
                            errorContainer.style.display = 'block';
                            var li = document.createElement('li');
                            li.textContent = 'Mất kết nối máy chủ. Vui lòng kiểm tra internet.';
                            errorList.appendChild(li);
                        }
                    }
                };

                // Mã hóa dữ liệu trước khi gửi đi
                var data = '__RequestVerificationToken=' + encodeURIComponent(token) +
                    '&Email=' + encodeURIComponent(email) +
                    '&MatKhau=' + encodeURIComponent(password) +
                    '&RememberMe=' + rememberMe +
                    '&Captcha=' + encodeURIComponent(captcha);

                xhr.send(data);
            });
        }

        /**
         * CHỈ MỞ MODAL ĐĂNG NHẬP KHI NGƯỜI DÙNG VỪA ĐỔI MẬT KHẨU THÀNH CÔNG
         * TempData được sinh ra từ Action ResetPassword POST
         */
        @if (TempData["PasswordResetSuccess"] != null) {
            <text>
            setTimeout(function() {
                if (window.openModal) {
                    window.openModal('login');
                }
            }, 500);
            </text>
        }
    });
</script>
