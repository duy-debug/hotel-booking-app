@model Project_65130650.Models.Forms.RegisterForm65130650

<div id="registerModal" class="auth-modal is-hidden" aria-hidden="true" role="dialog" aria-labelledby="registerModalTitle">
    <div class="auth-modal_backdrop" data-modal-close></div>
    <div class="auth-modal_panel" style="max-width: 480px;">
        <button type="button" class="auth-modal_close" aria-label="Đóng" data-modal-close>
            <i class="fas fa-times"></i>
        </button>

        <div class="auth-card white-bg" style="max-height: 85vh; overflow-y: auto;">
            <div class="auth-card_header" style="margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">
                <div class="auth-card_logo">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div>
                    <h1 id="registerModalTitle">Đăng Ký</h1>
                    <p>Tạo tài khoản để đặt phòng nhanh chóng</p>
                </div>
            </div>

            <div id="registerErrorContainer" class="auth-validation">
                <ul id="registerErrorList"></ul>
            </div>

            <div id="registerSuccessContainer" style="display: none; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 8px; padding: 12px; margin-bottom: 20px; color: #166534; font-size: 14px;">
                <i class="fas fa-check-circle"></i>
                <span id="registerSuccessMessage"></span>
            </div>

            <form id="registerForm" class="auth-form">
                @Html.AntiForgeryToken()

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Họ và tên <span style="color: red;">*</span></label>
                        <div class="input-wrapper">
                            @Html.TextBoxFor(m => m.HoTen, new { @class = "form-control", placeholder = "Nguyễn Văn A", id = "regHoTen" })
                            <i class="fas fa-user input-icon"></i>
                        </div>
                        <span class="field-validation-error" id="regHoTenError"></span>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Số điện thoại <span style="color: red;">*</span></label>
                        <div class="input-wrapper">
                            @Html.TextBoxFor(m => m.SoDienThoai, new { @class = "form-control", placeholder = "0901234567", id = "regSoDienThoai" })
                            <i class="fas fa-phone input-icon"></i>
                        </div>
                        <span class="field-validation-error" id="regSoDienThoaiError"></span>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label>Email <span style="color: red;">*</span></label>
                    <div class="input-wrapper">
                        @Html.TextBoxFor(m => m.Email, new { @class = "form-control", placeholder = "example@email.com", type = "email", id = "regEmail" })
                        <i class="fas fa-envelope input-icon"></i>
                    </div>
                    <span class="field-validation-error" id="regEmailError"></span>
                </div>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Mật khẩu <span style="color: red;">*</span></label>
                        <div class="input-wrapper">
                            @Html.PasswordFor(m => m.MatKhau, new { @class = "form-control", placeholder = "••••••••", id = "regMatKhau" })
                            <i class="fas fa-lock input-icon"></i>
                        </div>
                        <span class="field-validation-error" id="regMatKhauError"></span>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Xác nhận mật khẩu <span style="color: red;">*</span></label>
                        <div class="input-wrapper">
                            @Html.PasswordFor(m => m.XacNhanMatKhau, new { @class = "form-control", placeholder = "••••••••", id = "regXacNhanMatKhau" })
                            <i class="fas fa-lock input-icon"></i>
                        </div>
                        <span class="field-validation-error" id="regXacNhanMatKhauError"></span>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 10px 14px; border-radius: 10px; margin-bottom: 16px; font-size: 13px; color: #64748b; border: 1px solid #e2e8f0;">
                    <i class="fas fa-info-circle"></i> Mật khẩu: tối thiểu 8 ký tự, có chữ hoa, thường, số và ký tự đặc biệt.
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label>Địa chỉ</label>
                    <div class="input-wrapper">
                        @Html.TextBoxFor(m => m.DiaChi, new { @class = "form-control", placeholder = "Địa chỉ của bạn", id = "regDiaChi" })
                        <i class="fas fa-map-marker-alt input-icon"></i>
                    </div>
                </div>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Ngày sinh</label>
                        <div class="input-wrapper">
                            @Html.TextBoxFor(m => m.NgaySinh, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", id = "regNgaySinh" })
                            <i class="fas fa-calendar input-icon"></i>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Giới tính</label>
                        <div class="input-wrapper">
                            @Html.DropDownListFor(m => m.GioiTinh, new List<SelectListItem>
                            {
                                new SelectListItem { Text = "-- Chọn --", Value = "" },
                                new SelectListItem { Text = "Nam", Value = "Nam" },
                                new SelectListItem { Text = "Nữ", Value = "Nữ" },
                                new SelectListItem { Text = "Khác", Value = "Khác" }
                            }, new { @class = "form-control", id = "regGioiTinh" })
                            <i class="fas fa-venus-mars input-icon"></i>
                        </div>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 12px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; font-size: 13px; cursor: pointer; margin: 0; line-height: 1.4;">
                        @Html.CheckBoxFor(m => m.DongYDieuKhoan, new { id = "agreeTerms", style = "margin-top: 3px;" })
                        <span>Tôi đồng ý với <a href="https://policies.google.com/terms?hl=vi" style="color: #0d4ea6; font-weight: 600;">Điều khoản dịch vụ</a> và <a href="https://policies.google.com/privacy?hl=vi" style="color: #0d4ea6; font-weight: 600;">Chính sách bảo mật</a></span>
                    </label>
                </div>
                <span class="field-validation-error" id="regDongYDieuKhoanError" style="margin-top: -15px; margin-bottom: 15px; display: block;"></span>

                <button type="submit" class="btn-primary" id="registerSubmitBtn" style="width: 100%;">
                    <i class="fas fa-user-plus"></i> Đăng Ký Ngay
                </button>
            </form>

            <div style="text-align: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid #f1f5f9; font-size: 14px;">
                Đã có tài khoản?
                <button type="button" class="link-button" data-open-modal="login">Đăng nhập ngay</button>
            </div>
        </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var registerForm = document.getElementById('registerForm');
        var errorContainer = document.getElementById('registerErrorContainer');
        var errorList = document.getElementById('registerErrorList');
        var successContainer = document.getElementById('registerSuccessContainer');
        var successMessage = document.getElementById('registerSuccessMessage');
        var submitBtn = document.getElementById('registerSubmitBtn');

        function clearErrors() {
            errorContainer.style.display = 'none';
            errorList.innerHTML = '';
            successContainer.style.display = 'none';
            var errorSpans = document.querySelectorAll('#registerForm .field-validation-error');
            errorSpans.forEach(function (span) { span.textContent = ''; });
        }

        if (registerForm) {
            registerForm.addEventListener('submit', function (e) {
                e.preventDefault();
                clearErrors();

                var hoTen = document.getElementById('regHoTen').value.trim();
                var soDienThoai = document.getElementById('regSoDienThoai').value.trim();
                var email = document.getElementById('regEmail').value.trim();
                var matKhau = document.getElementById('regMatKhau').value;
                var xacNhanMatKhau = document.getElementById('regXacNhanMatKhau').value;
                var diaChi = document.getElementById('regDiaChi').value.trim();
                var ngaySinh = document.getElementById('regNgaySinh').value;
                var gioiTinh = document.getElementById('regGioiTinh').value;
                var dongYDieuKhoan = document.getElementById('agreeTerms').checked;

                var hasError = false;
                if (!hoTen) { document.getElementById('regHoTenError').textContent = 'Họ tên không được để trống'; hasError = true; }
                if (!soDienThoai) { document.getElementById('regSoDienThoaiError').textContent = 'SĐT không được để trống'; hasError = true; }
                else if (!/^0[0-9]{9,10}$/.test(soDienThoai)) { document.getElementById('regSoDienThoaiError').textContent = 'SĐT không hợp lệ'; hasError = true; }
                if (!email) { document.getElementById('regEmailError').textContent = 'Email không được để trống'; hasError = true; }
                if (!matKhau) { document.getElementById('regMatKhauError').textContent = 'Mật khẩu không được để trống'; hasError = true; }
                else if (matKhau.length < 8) { document.getElementById('regMatKhauError').textContent = 'Tối thiểu 8 ký tự'; hasError = true; }
                else if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@@$!%*?&])/.test(matKhau)) { 
                    document.getElementById('regMatKhauError').textContent = 'Phải có chữ hoa, thường, số và ký tự đặc biệt'; 
                    hasError = true; 
                }
                if (!xacNhanMatKhau) { document.getElementById('regXacNhanMatKhauError').textContent = 'Vui lòng xác nhận'; hasError = true; }
                else if (matKhau !== xacNhanMatKhau) { document.getElementById('regXacNhanMatKhauError').textContent = 'Mật khẩu không khớp'; hasError = true; }
                if (!dongYDieuKhoan) { document.getElementById('regDongYDieuKhoanError').textContent = 'Bạn phải đồng ý với điều khoản'; hasError = true; }
                if (hasError) return;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

                var token = registerForm.querySelector('input[name="__RequestVerificationToken"]').value;
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '@Url.Action("RegisterAjax", "Account65130650")', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Đăng Ký Ngay';

                        if (xhr.status === 200) {
                            try {
                                var response = JSON.parse(xhr.responseText);
                                if (response.success) {
                                    successContainer.style.display = 'block';
                                    successMessage.textContent = response.message;
                                    registerForm.reset();
                                    setTimeout(function () {
                                        document.getElementById('registerModal').classList.remove('is-active');
                                        document.getElementById('registerModal').setAttribute('aria-hidden', 'true');
                                        document.getElementById('loginModal').classList.add('is-active');
                                        document.getElementById('loginModal').setAttribute('aria-hidden', 'false');
                                    }, 1500);
                                } else {
                                    errorContainer.style.display = 'block';
                                    if (response.errors && response.errors.length > 0) {
                                        response.errors.forEach(function (err) {
                                            var li = document.createElement('li');
                                            li.textContent = err;
                                            errorList.appendChild(li);
                                        });
                                    }
                                }
                            } catch (ex) {
                                errorContainer.style.display = 'block';
                                var li = document.createElement('li');
                                li.textContent = 'Đã xảy ra lỗi';
                                errorList.appendChild(li);
                            }
                        } else {
                            errorContainer.style.display = 'block';
                            var li = document.createElement('li');
                            li.textContent = 'Không thể kết nối. Vui lòng thử lại.';
                            errorList.appendChild(li);
                        }
                    }
                };

                var data = '__RequestVerificationToken=' + encodeURIComponent(token) +
                    '&HoTen=' + encodeURIComponent(hoTen) +
                    '&SoDienThoai=' + encodeURIComponent(soDienThoai) +
                    '&Email=' + encodeURIComponent(email) +
                    '&MatKhau=' + encodeURIComponent(matKhau) +
                    '&XacNhanMatKhau=' + encodeURIComponent(xacNhanMatKhau) +
                    '&DiaChi=' + encodeURIComponent(diaChi) +
                    '&NgaySinh=' + encodeURIComponent(ngaySinh) +
                    '&GioiTinh=' + encodeURIComponent(gioiTinh) +
                    '&DongYDieuKhoan=' + dongYDieuKhoan;

                xhr.send(data);
            });
        }
    });
</script>
