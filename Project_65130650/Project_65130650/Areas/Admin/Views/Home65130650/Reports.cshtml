@{
    ViewBag.Title = "Báo cáo & Thống kê";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}


<div class="page-container">
    <div class="page-header">
        <div class="header-content">
            <p>Phân tích dữ liệu và báo cáo hệ thống</p>
        </div>
    </div>

    <div class="reports-grid">
        <!-- Revenue Report -->
        <div class="report-card">
            <div class="report-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-chart-bar"></i>
            </div>
            <h3>Doanh thu theo tháng</h3>
            <p>Xem biểu đồ doanh thu 6 tháng gần nhất</p>
            <button class="btn btn-outline" onclick="openModal('revenueModal')">Xem báo cáo</button>
        </div>

        <!-- Occupancy Report -->
        <div class="report-card">
            <div class="report-icon" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                <i class="fas fa-calendar-check"></i>
            </div>
            <h3>Tỷ lệ lấp đầy</h3>
            <p>Phân tích tỷ lệ lấp đầy phòng hiện tại</p>
            <button class="btn btn-outline" onclick="openModal('occupancyModal')">Xem báo cáo</button>
        </div>

        <!-- Customer Report -->
        <div class="report-card">
            <div class="report-icon" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
                <i class="fas fa-users"></i>
            </div>
            <h3>Khách hàng</h3>
            <p>Thống kê khách hàng mới và tổng khách hàng</p>
            <button class="btn btn-outline" onclick="openModal('customerModal')">Xem báo cáo</button>
        </div>

        <!-- Service Report -->
        <div class="report-card">
            <div class="report-icon" style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);">
                <i class="fas fa-concierge-bell"></i>
            </div>
            <h3>Dịch vụ</h3>
            <p>Top dịch vụ mang lại doanh thu cao nhất</p>
            <button class="btn btn-outline" onclick="openModal('serviceModal')">Xem báo cáo</button>
        </div>

        <!-- Room Report -->
        <div class="report-card">
            <div class="report-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                <i class="fas fa-door-open"></i>
            </div>
            <h3>Phòng</h3>
            <p>Loại phòng được đặt nhiều nhất</p>
            <button class="btn btn-outline" onclick="openModal('roomModal')">Xem báo cáo</button>
        </div>

        <!-- Payment Report -->
        <div class="report-card">
            <div class="report-icon" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <h3>Thanh toán</h3>
            <p>Thống kê phương thức thanh toán</p>
            <button class="btn btn-outline" onclick="openModal('paymentModal')">Xem báo cáo</button>
        </div>
    </div>
</div>

<!-- Modal Template Structure -->
<div id="revenueModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Báo cáo Doanh thu (6 tháng gần nhất)</h3>
            <span class="close" onclick="closeModal('revenueModal')">&times;</span>
        </div>
        <div class="modal-body">
            <canvas id="revenueChart"></canvas>
            <div class="table-responsive mt-3">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tháng/Năm</th>
                            <th>Số giao dịch</th>
                            <th>Doanh thu (VNĐ)</th>
                        </tr>
                    </thead>
                    <tbody id="revenueTableBody">
                        @{
                            decimal totalRevenue = 0;
                            int totalCount = 0;
                        }
                        @foreach (var item in ViewBag.MonthlyRevenue)
                        {
                            totalRevenue += item.Revenue;
                            totalCount += item.Count;
                            <tr>
                                <td>@item.Month/@item.Year</td>
                                <td>@item.Count</td>
                                <td>@item.Revenue.ToString("N0")</td>
                            </tr>
                        }
                        <tr style="font-weight: bold; background-color: #f9fafb; border-top: 2px solid #e5e7eb;">
                            <td style="text-align: right;">TỔNG CỘNG:</td>
                            <td>@totalCount</td>
                            <td class="text-primary">@totalRevenue.ToString("N0")</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="occupancyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Tỷ lệ lấp đầy hiện tại</h3>
            <span class="close" onclick="closeModal('occupancyModal')">&times;</span>
        </div>
        <div class="modal-body text-center">
            <div class="pie-chart-container">
                <canvas id="occupancyChart"></canvas>
            </div>
            <div class="mt-3">
                <h4>Tỷ lệ lấp đầy: <span class="text-primary">@Math.Round(ViewBag.CurrentOccupancyRate, 2)%</span></h4>
            </div>
        </div>
    </div>
</div>

<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Thống kê Khách hàng</h3>
            <span class="close" onclick="closeModal('customerModal')">&times;</span>
        </div>
        <div class="modal-body">
             <div class="stats-row">
                <div class="stat-box stat-blue">
                    <i class="fas fa-users"></i>
                    <div>
                        <div class="stat-number">@ViewBag.TotalCustomers</div>
                        <div class="stat-label">Tổng khách hàng</div>
                    </div>
                </div>
                <div class="stat-box stat-green">
                    <i class="fas fa-user-plus"></i>
                    <div>
                        <div class="stat-number">@ViewBag.NewCustomers</div>
                        <div class="stat-label">Khách hàng mới (Tháng này)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="serviceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Top 5 Dịch vụ Doanh thu cao nhất</h3>
            <span class="close" onclick="closeModal('serviceModal')">&times;</span>
        </div>
        <div class="modal-body">
            <canvas id="serviceChart"></canvas>
            <div class="table-responsive mt-3">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tên dịch vụ</th>
                            <th>Lượt dùng</th>
                            <th>Doanh thu</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ViewBag.TopServices)
                        {
                            <tr>
                                <td>@item.ServiceName</td>
                                <td>@item.UsageCount</td>
                                <td>@item.Revenue.ToString("N0")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="roomModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Top Loại phòng được đặt nhiều nhất</h3>
            <span class="close" onclick="closeModal('roomModal')">&times;</span>
        </div>
        <div class="modal-body">
             <canvas id="roomChart"></canvas>
             <div class="table-responsive mt-3">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Loại phòng</th>
                            <th>Số lượt đặt</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ViewBag.TopRoomTypes)
                        {
                            <tr>
                                <td>@item.RoomType</td>
                                <td>@item.BookingCount</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Phương thức thanh toán</h3>
            <span class="close" onclick="closeModal('paymentModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="pie-chart-container">
                <canvas id="paymentChart"></canvas>
            </div>
             <div class="table-responsive mt-3">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Phương thức</th>
                             <th>Số giao dịch</th>
                            <th>Tổng tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ViewBag.PaymentStats)
                        {
                            <tr>
                                <td>@item.Method</td>
                                <td>@item.Count</td>
                                <td>@item.Total.ToString("N0")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Data from ViewBag
        var monthlyRevenueData = @Html.Raw(Json.Encode(ViewBag.MonthlyRevenue));
        var topServicesData = @Html.Raw(Json.Encode(ViewBag.TopServices));
        var topRoomTypesData = @Html.Raw(Json.Encode(ViewBag.TopRoomTypes));
        var paymentStatsData = @Html.Raw(Json.Encode(ViewBag.PaymentStats));
        var currentOccupancyRate = @ViewBag.CurrentOccupancyRate;

        // --- Charts Initialization ---

        // 1. Revenue Chart
        var revenueCtx = document.getElementById('revenueChart').getContext('2d');
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: monthlyRevenueData.map(d => d.Month + '/' + d.Year),
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: monthlyRevenueData.map(d => d.Revenue),
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: { responsive: true }
        });

        // 2. Occupancy Chart (Pie)
        var occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
        new Chart(occupancyCtx, {
            type: 'doughnut',
            data: {
                labels: ['Đang sử dụng', 'Còn trống'],
                datasets: [{
                    data: [currentOccupancyRate, 100 - currentOccupancyRate],
                    backgroundColor: ['#22c55e', '#e5e7eb']
                }]
            },
            options: { responsive: true }
        });

        // 3. Service Chart (Bar)
        var serviceCtx = document.getElementById('serviceChart').getContext('2d');
        new Chart(serviceCtx, {
            type: 'bar',
            data: {
                labels: topServicesData.map(d => d.ServiceName),
                datasets: [{
                    label: 'Doanh thu',
                    data: topServicesData.map(d => d.Revenue),
                    backgroundColor: '#a855f7'
                }]
            },
            options: { responsive: true }
        });

         // 4. Room Chart (Bar)
        var roomCtx = document.getElementById('roomChart').getContext('2d');
        new Chart(roomCtx, {
            type: 'bar',
            data: {
                labels: topRoomTypesData.map(d => d.RoomType),
                datasets: [{
                    label: 'Số lượt đặt',
                    data: topRoomTypesData.map(d => d.BookingCount),
                    backgroundColor: '#06b6d4'
                }]
            },
            options: { responsive: true, indexAxis: 'y' } 
        });

        // 5. Payment Chart (Pie)
        var paymentCtx = document.getElementById('paymentChart').getContext('2d');
        new Chart(paymentCtx, {
            type: 'pie',
            data: {
                labels: paymentStatsData.map(d => d.Method),
                datasets: [{
                    data: paymentStatsData.map(d => d.Total),
                    backgroundColor: ['#ec4899', '#f97316', '#3b82f6', '#10b981']
                }]
            },
            options: { responsive: true }
        });


        // --- Modal Handling ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }
    </script>
}

@section Styles {
    <style>
        .page-container { padding: 30px; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        .header-content h1 { font-size: 28px; font-weight: 700; color: #111827; margin: 0 0 8px 0; display: flex; align-items: center; gap: 12px; }
        .header-content h1 i { color: #4f46e5; }
        .header-content p { color: #6b7280; margin: 0; }
        
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        .report-card { background: white; border-radius: 16px; padding: 32px; box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08); transition: all 0.3s ease; text-align: center; }
        .report-card:hover { transform: translateY(-8px); box-shadow: 0 12px 40px rgba(15, 23, 42, 0.15); }
        .report-icon { width: 80px; height: 80px; border-radius: 16px; color: white; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 20px; }
        .report-card h3 { margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: #111827; }
        .report-card p { color: #6b7280; font-size: 14px; line-height: 1.6; margin-bottom: 24px; }
        
        .btn-outline { background: white; color: #4f46e5; border: 2px solid #4f46e5; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; display: block; }
        .btn-outline:hover { background: #4f46e5; color: white; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 800px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 1.25rem; font-weight: 600; }
        .modal-body { padding: 20px; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close:hover { color: #000; }

        /* Table inside modal */
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .data-table th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        .mt-3 { margin-top: 1rem; }
        .text-center { text-align: center; }
        .text-primary { color: #4f46e5; }
        
        .pie-chart-container { width: 300px; margin: 0 auto; }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-box { background: #f9fafb; padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 16px; }
        .stat-box i { font-size: 24px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: white; }
        .stat-blue i { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-green i { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .stat-number { font-size: 24px; font-weight: 700; color: #111827; }
        .stat-label { font-size: 13px; color: #6b7280; }
    </style>
}
