@model IEnumerable<Project_65130650.Models.ThanhToan>
@{
    ViewBag.Title = "Quản lý Thanh toán";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="page-container">
    <div class="page-header">
        <div class="header-content">
            <h1><i class="fas fa-money-bill-wave"></i> Quản lý Thanh toán</h1>
            <p>Danh sách tất cả các giao dịch thanh toán</p>
        </div>
        <div class="header-actions">    
            <button class="btn btn-primary" onclick="openCreateModal()">
                <i class="fas fa-plus"></i> Nhận thanh toán
            </button>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-box stat-green">
            <i class="fas fa-dollar-sign"></i>
            <div>
                <div class="stat-number">@String.Format("{0:N0}", ViewBag.TotalRevenue) VNĐ</div>
                <div class="stat-label">Tổng doanh thu</div>
            </div>
        </div>
        <div class="stat-box stat-blue">
            <i class="fas fa-receipt"></i>
            <div>
                <div class="stat-number">@ViewBag.TotalTrans</div>
                <div class="stat-label">Tổng giao dịch</div>
            </div>
        </div>
        <div class="stat-box stat-purple">
            <i class="fas fa-credit-card"></i>
            <div>
                <div class="stat-number">@ViewBag.TransferCount</div>
                <div class="stat-label">Chuyển khoản</div>
            </div>
        </div>
        <div class="stat-box stat-orange">
            <i class="fas fa-money-bill"></i>
            <div>
                <div class="stat-number">@ViewBag.CashCount</div>
                <div class="stat-label">Tiền mặt</div>
            </div>
        </div>
    </div>

    <div class="content-card">
        <div class="card-body">
            <div class="table-controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" value="@ViewBag.Search" placeholder="Tìm kiếm theo mã TT, mã ĐP, tên KH...">
                </div>
                <div class="filter-group">
                    <select id="statusFilter" class="form-select" onchange="performSearch()">
                        <option value="">Tất cả trạng thái</option>
                        <option value="Thành công" @(ViewBag.Status == "Thành công" ? "selected" : "")>Thành công</option>
                        <option value="Chờ xử lý" @(ViewBag.Status == "Chờ xử lý" ? "selected" : "")>Chờ xử lý</option>
                        <option value="Thất bại" @(ViewBag.Status == "Thất bại" ? "selected" : "")>Thất bại</option>
                        <option value="Đã hoàn tiền" @(ViewBag.Status == "Đã hoàn tiền" ? "selected" : "")>Đã hoàn tiền</option>
                    </select>
                    <select id="methodFilter" class="form-select" onchange="performSearch()">
                        <option value="">Tất cả phương thức</option>
                        <option value="Tiền mặt" @(ViewBag.Method == "Tiền mặt" ? "selected" : "")>Tiền mặt</option>
                        <option value="Chuyển khoản" @(ViewBag.Method == "Chuyển khoản" ? "selected" : "")>Chuyển khoản</option>
                    </select>
                    <div style="display:flex; align-items:center; gap: 5px;">
                        <input type="date" id="fromDate" class="form-control" value="@ViewBag.FromDate" onchange="performSearch()" title="Từ ngày">
                        <span>-</span>
                        <input type="date" id="toDate" class="form-control" value="@ViewBag.ToDate" onchange="performSearch()" title="Đến ngày">
                    </div>
                </div>
            </div>

            <div id="tableContainer">
                @if (Model != null && Model.Any())
                {
                    <div class="table-responsive">
                        <table class="data-table" id="paymentsTable">
                            <thead>
                                <tr>
                                    <th>Mã TT</th>
                                    <th>Mã ĐP</th>
                                    <th>Khách hàng</th>
                                    <th>Ngày thanh toán</th>
                                    <th>Tổng tiền</th>
                                    <th>Phương thức</th>
                                    <th>Trạng thái</th>
                                    <th>Người xử lý</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var payment in Model)
                                {
                                    <tr>
                                        <td><span class="badge badge-primary">@payment.maThanhToan</span></td>
                                        <td><span class="badge badge-info">@payment.maDatPhong</span></td>
                                        <td>@(payment.DatPhong != null && payment.DatPhong.NguoiDung != null ? payment.DatPhong.NguoiDung.hoTen : "---")</td>
                                        <td>@(payment.ngayThanhToan.HasValue ? payment.ngayThanhToan.Value.ToString("dd/MM/yyyy HH:mm") : "---")</td>
                                        <td><strong class="text-success">@String.Format("{0:N0}", payment.soTien) VNĐ</strong></td>
                                        <td>
                                            @if (payment.phuongThucThanhToan == "Tiền mặt")
                                            {
                                                <span class="badge badge-warning"><i class="fas fa-money-bill"></i> Tiền mặt</span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-info"><i class="fas fa-credit-card"></i> Chuyển khoản</span>
                                            }
                                        </td>
                                        <td>
                                            @if (payment.trangThaiThanhToan == "Thành công" || payment.trangThaiThanhToan == "Đã thanh toán")
                                            {
                                                <span class="badge badge-success"><i class="fas fa-check-circle"></i> Thành công</span>
                                            }
                                            else if (payment.trangThaiThanhToan == "Chờ xử lý")
                                            {
                                                <span class="badge badge-warning"><i class="fas fa-clock"></i> Chờ xử lý</span>
                                            }
                                            else if (payment.trangThaiThanhToan == "Đã hoàn tiền")
                                            {
                                                <span class="badge badge-purple"><i class="fas fa-undo"></i> Đã hoàn tiền</span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-danger"><i class="fas fa-times-circle"></i> @payment.trangThaiThanhToan</span>
                                            }
                                        </td>
                                        <td>
                                            <span style="font-size: 12px; color: #666;">
                                                @(payment.NguoiDung != null ? payment.NguoiDung.hoTen : (payment.nguoiXuLy ?? "System"))
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn-icon btn-info" onclick="viewPayment('@payment.maThanhToan')" title="Xem chi tiết">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    if (ViewBag.TotalPages > 1)
                    {
                        <div class="pagination-wrapper">
                            <div class="pagination-controls">
                                @if (ViewBag.CurrentPage > 1)
                                {
                                    <a href="javascript:void(0)" onclick="changePage(@(ViewBag.CurrentPage - 1))" class="pagination-btn prev">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                }

                                @for (int i = Math.Max(1, ViewBag.CurrentPage - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2); i++)
                                {
                                    if (i == ViewBag.CurrentPage)
                                    {
                                        <span class="pagination-btn current">@i</span>
                                    }
                                    else
                                    {
                                        <a href="javascript:void(0)" onclick="changePage(@i)" class="pagination-btn">@i</a>
                                    }
                                }

                                @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                                {
                                    <a href="javascript:void(0)" onclick="changePage(@(ViewBag.CurrentPage + 1))" class="pagination-btn next">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>Chưa có giao dịch nào phù hợp</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal Tạo Thanh Toán -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Nhận thanh toán mới</h3>
            <span class="close" onclick="closeCreateModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="createPaymentForm">
                @Html.AntiForgeryToken()
                <div class="form-group">
                    <label>Đơn đặt phòng chưa thanh toán <span class="text-danger">*</span></label>
                    <select class="form-control" id="maDatPhong" name="maDatPhong" required onchange="loadDebtInfo(this.value)">
                        <option value="">-- Chọn đơn đặt phòng --</option>
                        @if (ViewBag.PendingBookings != null)
                        {
                            foreach (var booking in (IEnumerable<SelectListItem>)ViewBag.PendingBookings)
                            {
                                <option value="@booking.Value">@booking.Text</option>
                            }
                        }
                    </select>
                </div>
                
                <!-- Khu vực hiển thị thông tin công nợ -->
                <div id="debtInfo" style="display:none; background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #ccc;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666;">Tiền phòng:</span>
                        <span id="infoTienPhong" style="font-weight: 600;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666;">Tiền dịch vụ:</span>
                        <span id="infoTienDichVu" style="font-weight: 600;">0</span>
                    </div>
                    <div style="border-top: 1px solid #ddd; margin: 5px 0;"></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #111827;">Tổng phải trả:</span>
                        <span id="infoTongTien" style="font-weight: 700; color: #2563eb;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666;">Đã thanh toán:</span>
                        <span id="infoDaThanhToan" style="font-weight: 600; color: #16a34a;">0</span>
                    </div>
                     <div style="border-top: 1px solid #ddd; margin: 5px 0;"></div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #dc2626; font-weight: 700;">Còn lại cần trả:</span>
                        <span id="infoConLai" style="font-weight: 700; color: #dc2626; font-size: 16px;">0</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Số tiền (VNĐ) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="soTien" name="soTien" required min="1000">
                    </div>
                    <div class="form-group col-md-6">
                        <label>Phương thức <span class="text-danger">*</span></label>
                        <select class="form-control" id="phuongThucThanhToan" name="phuongThucThanhToan" required>
                            <option value="Tiền mặt">Tiền mặt</option>
                            <option value="Chuyển khoản">Chuyển khoản</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ghi chú</label>
                    <textarea class="form-control" id="ghiChu" name="ghiChu" rows="3"></textarea>
                </div>
                <div class="text-right mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">Xác nhận thanh toán</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Chi tiết Thanh Toán -->
<div id="viewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chi tiết Giao dịch</h3>
            <span class="close" onclick="closeViewModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="detail-grid" id="paymentDetails">
                <!-- Loaded via JS -->
            </div>
            
            <div id="actionButtons" class="text-right mt-3" style="display:none; border-top: 1px solid #eee; padding-top: 15px;">
                <!-- Confirm / Refund buttons injected here -->
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .page-container { padding: 30px; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        .header-content h1 { font-size: 28px; font-weight: 700; color: #111827; margin: 0 0 8px 0; display: flex; align-items: center; gap: 12px; }
        .header-content p { color: #6b7280; margin: 0; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
        .stat-box i { font-size: 28px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .stat-green i { background: #dcfce7; color: #16a34a; }
        .stat-blue i { background: #dbeafe; color: #2563eb; }
        .stat-purple i { background: #f3e8ff; color: #9333ea; }
        .stat-orange i { background: #ffedd5; color: #ea580c; }
        .stat-number { font-size: 20px; font-weight: 700; color: #111827; }
        .stat-label { font-size: 13px; color: #6b7280; }
        
        .content-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08); overflow: hidden; min-height: 600px; }
        .card-body { padding: 30px; }
        
        .table-controls { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
        .search-box { flex: 1; position: relative; min-width: 250px; }
        .search-box i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .search-box input { width: 100%; padding: 10px 16px 10px 40px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .filter-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-select, .form-control { padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; }
        
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: #6b7280; background: #f9fafb; white-space: nowrap; }
        .data-table td { padding: 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-info { background: #dbeafe; color: #2563eb; }
        .badge-primary { background: #eef2ff; color: #4f46e5; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-purple { background: #f3e8ff; color: #9333ea; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: #4f46e5; color: white; }
        .btn-secondary { background: #9ca3af; color: white; }
        .btn-success { background: #16a34a; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-icon { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 1.25rem; font-weight: 600; }
        .modal-body { padding: 20px; }
        .close { font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .close:hover { color: black; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #374151; font-weight: 500; }
        .form-control { width: 100%; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .text-danger { color: #dc2626; }
        .text-right { text-align: right; }
        .mt-3 { margin-top: 1rem; }
        
        .detail-item { margin-bottom: 10px; display: grid; grid-template-columns: 120px 1fr; gap: 10px; }
        .detail-item label { color: #6b7280; font-size: 13px; }
        .detail-item span { color: #111827; font-weight: 500; }

        /* Pagination */
        .pagination-wrapper { display: flex; justify-content: center; margin-top: 20px; }
        .pagination-controls { display: flex; gap: 5px; }
        .pagination-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; border-radius: 4px; text-decoration: none; color: #374151; }
        .pagination-btn.current { background: #4f46e5; color: white; border-color: #4f46e5; }
        .pagination-btn:hover:not(.current) { background: #f9fafb; }
        
        .empty-state { text-align: center; padding: 40px; color: #9ca3af; }
    </style>
}

@section Scripts {
    <script>
        // Debounce search
        var searchTimer;
        $('#searchInput').on('input', function() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(performSearch, 500);
        });

        function performSearch(page = 1) {
            var search = $('#searchInput').val();
            var status = $('#statusFilter').val();
            var method = $('#methodFilter').val();
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            
            var url = '@Url.Action("Payments", "Home65130650", new { area = "Admin" })';
            
            $.ajax({
                url: url,
                type: 'GET',
                data: { page: page, search: search, status: status, method: method, fromDate: fromDate, toDate: toDate },
                success: function(result) {
                    var newContent = $(result).find('#tableContainer').html();
                    $('#tableContainer').html(newContent);
                },
                error: function() {
                    console.error('Lỗi tải dữ liệu');
                }
            });
        }

        function changePage(page) {
            performSearch(page);
        }

        // Modal Logic
        function openCreateModal() {
            $('#createPaymentForm')[0].reset();
            $('#createModal').fadeIn(200);
            $('#debtInfo').hide(); // Hide debt info initially
        }

        function closeCreateModal() {
            $('#createModal').fadeOut(200);
        }

        function closeViewModal() {
            $('#viewModal').fadeOut(200);
        }

        // Close on outside click
        $(window).on('click', function(e) {
            if ($(e.target).is('.modal')) {
                $('.modal').fadeOut(200);
            }
        });

        // Load Debt Info
        function loadDebtInfo(maDatPhong) {
             if (!maDatPhong) {
                 $('#debtInfo').slideUp();
                 return;
             }

             $.ajax({
                 url: '@Url.Action("GetBookingDebtInfo", "Home65130650", new { area = "Admin" })',
                 type: 'GET',
                 data: { id: maDatPhong },
                 success: function(res) {
                     if (res.success) {
                         var d = res.data;
                         // Format currency
                         var fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
                         
                         $('#infoTienPhong').text(fmt.format(d.tienPhong));
                         $('#infoTienDichVu').text(fmt.format(d.tienDichVu));
                         $('#infoTongTien').text(fmt.format(d.tongTien));
                         $('#infoDaThanhToan').text(fmt.format(d.daThanhToan));
                         $('#infoConLai').text(fmt.format(d.conLai));

                         // Auto-fill amount to calculate remaining
                         $('#soTien').val(d.conLai);

                         $('#debtInfo').slideDown();
                     } else {
                         alert(res.error);
                     }
                 }
             });
        }

        // Submit Create Payment
        $('#createPaymentForm').on('submit', function(e) {
            e.preventDefault();
            var url = '@Url.Action("CreatePayment", "Home65130650", new { area = "Admin" })';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: $(this).serialize(),
                success: function(res) {
                    if (res.success) {
                        alert(res.message);
                        closeCreateModal();
                        performSearch(1);
                    } else {
                        alert(res.error);
                    }
                },
                error: function() {
                    alert('Lỗi hệ thống');
                }
            });
        });

        // View Payment Details
        var currentPaymentId = '';
        function viewPayment(id) {
            currentPaymentId = id;
            var url = '@Url.Action("GetPaymentDetails", "Home65130650", new { area = "Admin" })';
            
            $.ajax({
                url: url,
                type: 'GET',
                data: { id: id },
                success: function(res) {
                    if (res.success) {
                        var d = res.data;
                        var html = `
                            <div class="detail-item"><label>Mã giao dịch:</label><span>${d.maThanhToan}</span></div>
                            <div class="detail-item"><label>Mã đặt phòng:</label><span>${d.maDatPhong}</span></div>
                            <div class="detail-item"><label>Khách hàng:</label><span>${d.customerName}</span></div>
                            <div class="detail-item"><label>Ngày thanh toán:</label><span>${d.ngayThanhToan}</span></div>
                            <div class="detail-item"><label>Số tiền:</label><span class="text-success">${parseFloat(d.soTien).toLocaleString('vi-VN')} VNĐ</span></div>
                            <div class="detail-item"><label>Phương thức:</label><span>${d.phuongThucThanhToan}</span></div>
                            <div class="detail-item"><label>Trạng thái:</label><span>${d.trangThaiThanhToan}</span></div>
                            <div class="detail-item"><label>Người xử lý:</label><span>${d.handlerName || '---'}</span></div>
                            <div class="detail-item"><label>Ghi chú:</label><span>${d.ghiChu || '---'}</span></div>
                        `;
                        $('#paymentDetails').html(html);
                        
                        // Setup Actions based on status
                        var actionsHtml = '';
                        if (d.trangThaiThanhToan === 'Chờ xử lý') {
                            actionsHtml = `
                                <button class="btn btn-secondary" onclick="closeViewModal()">Đóng</button>
                                <button class="btn btn-success" onclick="confirmPayment('${d.maThanhToan}')">
                                    <i class="fas fa-check"></i> Xác nhận thanh toán
                                </button>
                            `;
                        } else if (d.trangThaiThanhToan === 'Thành công' || d.trangThaiThanhToan === 'Đã thanh toán') {
                            actionsHtml = `
                                <button class="btn btn-secondary" onclick="closeViewModal()">Đóng</button>
                                <button class="btn btn-danger" onclick="refundPayment('${d.maThanhToan}')">
                                    <i class="fas fa-undo"></i> Hoàn tiền
                                </button>
                            `;
                        } else {
                            actionsHtml = `<button class="btn btn-secondary" onclick="closeViewModal()">Đóng</button>`;
                        }
                        
                        $('#actionButtons').html(actionsHtml).show();
                        $('#viewModal').fadeIn(200);
                    } else {
                        alert(res.error);
                    }
                }
            });
        }

        function confirmPayment(id) {
            if (confirm('Xác nhận thanh toán này đã thành công?')) {
                updateStatus(id, 'Thành công');
            }
        }

        function refundPayment(id) {
            var reason = prompt('Nhập lý do hoàn tiền:');
            if (reason) {
                updateStatus(id, 'Đã hoàn tiền', reason);
            }
        }

        function updateStatus(id, status, reason = '') {
            var url = '@Url.Action("UpdatePaymentStatus", "Home65130650", new { area = "Admin" })';
            $.ajax({
                url: url,
                type: 'POST',
                data: { id: id, status: status, reason: reason },
                success: function(res) {
                    if (res.success) {
                        alert(res.message);
                        closeViewModal();
                        performSearch(); // Refresh list
                    } else {
                        alert(res.error);
                    }
                }
            });
        }
    </script>
}
