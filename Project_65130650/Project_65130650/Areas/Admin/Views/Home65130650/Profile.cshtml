@model Project_65130650.Models.NguoiDung
@{
    ViewBag.Title = "Hồ sơ của tôi";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="page-container">
    <div class="page-header">
        <div class="header-content">
            <h3>Quản lý thông tin cá nhân</h3>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" id="btnEdit">
                <i class="fas fa-edit"></i> Chỉnh sửa
            </button>
        </div>
    </div>

    @if (Model != null)
    {
        <div class="profile-container">
            <div class="profile-sidebar">
                <div class="profile-avatar">
                    @Model.hoTen.Substring(0, 1).ToUpper()
                </div>
                <h2>@Model.hoTen</h2>
                <p class="role-badge">@Model.vaiTro</p>
                <div class="status-badge">
                    @if (Model.trangThaiHoatDong == true || Model.trangThaiHoatDong == null)
                    {
                        <i class="fas fa-check-circle"></i>
                        <span>Đang hoạt động</span>
                    }
                    else
                    {
                        <i class="fas fa-ban"></i>
                        <span>Ngừng hoạt động</span>
                    }
                </div>
            </div>

            <div class="profile-content">
                <!-- View Mode -->
                <div id="viewMode">
                    <div class="info-section">
                        <h3><i class="fas fa-info-circle"></i> Thông tin cơ bản</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Họ và tên</label>
                                <span>@Model.hoTen</span>
                            </div>
                            <div class="info-item">
                                <label>Email</label>
                                <span>@Model.email</span>
                            </div>
                            <div class="info-item">
                                <label>Số điện thoại</label>
                                <span>@(Model.soDienThoai ?? "Chưa cập nhật")</span>
                            </div>
                            <div class="info-item">
                                <label>Giới tính</label>
                                <span>@(Model.gioiTinh ?? "Chưa cập nhật")</span>
                            </div>
                            <div class="info-item">
                                <label>Ngày sinh</label>
                                <span>@(Model.ngaySinh.HasValue ? String.Format("{0:dd/MM/yyyy}", Model.ngaySinh) : "Chưa cập nhật")</span>
                            </div>
                            <div class="info-item">
                                <label>Địa chỉ</label>
                                <span>@(Model.diaChi ?? "Chưa cập nhật")</span>
                            </div>
                            <div class="info-item">
                                <label>Ngày tạo</label>
                                <span>@String.Format("{0:dd/MM/yyyy HH:mm}", Model.ngayTao)</span>
                            </div>
                            <div class="info-item">
                                <label>Cập nhật lần cuối</label>
                                <span>@(Model.ngayCapNhat.HasValue ? String.Format("{0:dd/MM/yyyy HH:mm}", Model.ngayCapNhat) : "Chưa cập nhật")</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div id="editMode" style="display: none;">
                    @using (Html.BeginForm("UpdateProfile", "Home65130650", new { area = "Admin" }, FormMethod.Post, new { @class = "edit-form", id = "profileForm" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.maNguoiDung)
                        
                        <div class="info-section">
                            <h3><i class="fas fa-edit"></i> Chỉnh sửa thông tin</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="hoTen">Họ và tên <span class="required">*</span></label>
                                    @Html.TextBoxFor(m => m.hoTen, new { @class = "form-control", required = "required" })
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email <span class="required">*</span></label>
                                    @Html.TextBoxFor(m => m.email, new { @class = "form-control", type = "email", required = "required", @readonly = "readonly" })
                                    <small class="form-text">Email không thể thay đổi</small>
                                </div>

                                <div class="form-group">
                                    <label for="soDienThoai">Số điện thoại</label>
                                    @Html.TextBoxFor(m => m.soDienThoai, new { @class = "form-control", type = "tel", pattern = "[0-9]{10,11}" })
                                </div>

                                <div class="form-group">
                                    <label for="gioiTinh">Giới tính</label>
                                    @Html.DropDownListFor(m => m.gioiTinh, new SelectList(new[] { 
                                        new { Value = "Nam", Text = "Nam" },
                                        new { Value = "Nữ", Text = "Nữ" },
                                        new { Value = "Khác", Text = "Khác" }
                                    }, "Value", "Text", Model.gioiTinh), "-- Chọn giới tính --", new { @class = "form-control" })
                                </div>

                                <div class="form-group">
                                    <label for="ngaySinh">Ngày sinh</label>
                                    @Html.TextBoxFor(m => m.ngaySinh, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                                </div>

                                <div class="form-group full-width">
                                    <label for="diaChi">Địa chỉ</label>
                                    @Html.TextAreaFor(m => m.diaChi, new { @class = "form-control", rows = 3 })
                                </div>
                            </div>
                        </div>

                        <div class="info-section">
                            <h3><i class="fas fa-lock"></i> Đổi mật khẩu</h3>
                            <p class="section-note">Để trống nếu không muốn thay đổi mật khẩu</p>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="currentPassword">Mật khẩu hiện tại</label>
                                    <input type="password" id="currentPassword" name="currentPassword" class="form-control" />
                                    <span class="error-message" id="currentPasswordError"></span>
                                </div>

                                <div class="form-group">
                                    <label for="newPassword">Mật khẩu mới</label>
                                    <input type="password" id="newPassword" name="newPassword" class="form-control" />
                                    <span class="error-message" id="newPasswordError"></span>
                                    <div class="password-requirements" id="passwordRequirements" style="display: none;">
                                        <p class="req-title">Mật khẩu phải có:</p>
                                        <div class="req-item" id="req-length">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Ít nhất 8 ký tự</span>
                                        </div>
                                        <div class="req-item" id="req-uppercase">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Ít nhất 1 chữ hoa</span>
                                        </div>
                                        <div class="req-item" id="req-number">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Ít nhất 1 chữ số</span>
                                        </div>
                                        <div class="req-item" id="req-special">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Ít nhất 1 ký tự đặc biệt</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="confirmPassword">Xác nhận mật khẩu mới</label>
                                    <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" />
                                    <span class="error-message" id="confirmPasswordError"></span>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions-footer">
                            <button type="button" class="btn btn-secondary" id="btnCancel">
                                <i class="fas fa-times"></i> Hủy bỏ
                            </button>
                            <button type="submit" class="btn btn-success" id="btnSave">
                                <i class="fas fa-save"></i> Lưu thay đổi
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="empty-state">
            <i class="fas fa-user-slash"></i>
            <p>Không tìm thấy thông tin người dùng</p>
        </div>
    }
</div>

@section Styles {
    <style>
        .page-container { padding: 30px; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        .header-content h1 { font-size: 28px; font-weight: 700; color: #111827; margin: 0 0 8px 0; display: flex; align-items: center; gap: 12px; }
        .header-content h1 i { color: #0d4ea6; }
        .header-content p { color: #6b7280; margin: 0; }
        .header-actions { display: flex; gap: 12px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #0d4ea6; color: white; }
        .btn-primary:hover { background: #0a3d82; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(13, 78, 166, 0.3); }
        .btn-success { background: #22c55e; color: white; }
        .btn-success:hover { background: #16a34a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        /* Alert Styles */
        .alert { padding: 16px 20px; border-radius: 8px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; font-weight: 500; animation: slideDown 0.3s ease; }
        .alert-success { background: #dcfce7; color: #16a34a; border: 1px solid #22c55e; }
        .alert-error { background: #fee2e2; color: #dc2626; border: 1px solid #ef4444; }
        @@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .profile-container { display: grid; grid-template-columns: 300px 1fr; gap: 30px; align-items: start; }
        .profile-sidebar { background: white; border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08); height: fit-content; position: sticky; top: 100px; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #0d4ea6 0%, #173b75 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 700; margin: 0 auto 20px; }
        .profile-sidebar h2 { margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: #111827; }
        .role-badge { display: inline-block; padding: 8px 16px; background: #fee2e2; color: #dc2626; border-radius: 20px; font-weight: 600; font-size: 14px; margin-bottom: 16px; }
        .status-badge { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: #dcfce7; color: #16a34a; border-radius: 8px; font-weight: 600; }
        .profile-content { background: white; border-radius: 16px; padding: 40px; box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08); }
        .info-section { margin-bottom: 40px; }
        .info-section:last-child { margin-bottom: 0; }
        .info-section h3 { margin: 0 0 24px 0; font-size: 20px; font-weight: 700; color: #111827; display: flex; align-items: center; gap: 12px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb; }
        .info-section h3 i { color: #0d4ea6; }
        .section-note { color: #6b7280; font-size: 14px; margin-bottom: 20px; font-style: italic; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .info-item { display: flex; flex-direction: column; gap: 8px; }
        .info-item label { font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-item span { font-size: 16px; color: #111827; }
        
        /* Form Styles */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; position: relative; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-size: 14px; font-weight: 600; color: #374151; }
        .required { color: #dc2626; }
        .form-control { padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; width: 100%; box-sizing: border-box; }
        .form-control:focus { outline: none; border-color: #0d4ea6; box-shadow: 0 0 0 3px rgba(13, 78, 166, 0.1); }
        .form-control:read-only { background: #f9fafb; cursor: not-allowed; }
        .form-control.error { border-color: #dc2626; }
        .form-text { font-size: 12px; color: #6b7280; margin-top: 4px; }
        
        .form-actions-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Error Message Styles */
        .error-message { color: #dc2626; font-size: 13px; font-weight: 500; margin-top: 4px; display: none; }
        .error-message.show { display: block; animation: fadeIn 0.3s ease; }
        @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Password Requirements */
        .password-requirements { margin-top: 12px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
        .req-title { font-size: 13px; font-weight: 600; color: #374151; margin: 0 0 12px 0; }
        .req-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 13px; color: #6b7280; }
        .req-item:last-child { margin-bottom: 0; }
        .req-item i { width: 16px; }
        .req-item.valid { color: #16a34a; }
        .req-item.valid i { color: #16a34a; }
        .req-item.valid i::before { content: "\f058"; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; background: white; border-radius: 16px; }
        .empty-state i { font-size: 48px; margin-bottom: 16px; display: block; }
        
        @@media (max-width: 768px) {
            .profile-container { grid-template-columns: 1fr; }
            .info-grid, .form-grid { grid-template-columns: 1fr; }
            .header-actions { flex-direction: column; width: 100%; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Toggle Edit Mode
            $('#btnEdit').click(function() {
                $('#viewMode').hide();
                $('#editMode').show();
                $('#btnEdit').hide();
                // Clear any previous alerts
                $('.alert').remove();
            });

            // Cancel Edit
            $('#btnCancel').click(function() {
                $('#editMode').hide();
                $('#viewMode').show();
                $('#btnEdit').show();
                // Reset form and errors
                $('#profileForm')[0].reset();
                $('.error-message').removeClass('show').text('');
                $('.form-control').removeClass('error');
                $('#passwordRequirements').hide();
                $('.alert').remove();
            });

            // Password validation realtime
            $('#newPassword').on('input', function() {
                var password = $(this).val();
                
                if (password.length > 0) {
                    $('#passwordRequirements').show();
                    
                    // Check length
                    if (password.length >= 8) {
                        $('#req-length').addClass('valid');
                    } else {
                        $('#req-length').removeClass('valid');
                    }
                    
                    // Check uppercase
                    if (/[A-Z]/.test(password)) {
                        $('#req-uppercase').addClass('valid');
                    } else {
                        $('#req-uppercase').removeClass('valid');
                    }
                    
                    // Check number
                    if (/[0-9]/.test(password)) {
                        $('#req-number').addClass('valid');
                    } else {
                        $('#req-number').removeClass('valid');
                    }
                    
                    // Check special character
                    if (/[^A-Za-z0-9]/.test(password)) {
                        $('#req-special').addClass('valid');
                    } else {
                        $('#req-special').removeClass('valid');
                    }
                } else {
                    $('#passwordRequirements').hide();
                }
                
                // Clear error when typing
                $('#newPasswordError').removeClass('show').text('');
                $('#newPassword').removeClass('error');
            });

            // Confirm password validation
            $('#confirmPassword').on('input', function() {
                var newPwd = $('#newPassword').val();
                var confirmPwd = $(this).val();
                
                if (confirmPwd.length > 0) {
                    if (newPwd !== confirmPwd) {
                        $('#confirmPasswordError').addClass('show').text('Mật khẩu xác nhận không khớp');
                        $('#confirmPassword').addClass('error');
                    } else {
                        $('#confirmPasswordError').removeClass('show').text('');
                        $('#confirmPassword').removeClass('error');
                    }
                } else {
                    $('#confirmPasswordError').removeClass('show').text('');
                    $('#confirmPassword').removeClass('error');
                }
            });

            // Save Changes
            $('#btnSave').click(function(e) {
                e.preventDefault();
                
                // Clear all errors
                $('.error-message').removeClass('show').text('');
                $('.form-control').removeClass('error');
                
                var isValid = true;
                var currentPwd = $('#currentPassword').val();
                var newPwd = $('#newPassword').val();
                var confirmPwd = $('#confirmPassword').val();

                // Validate password if any field is filled
                if (newPwd || confirmPwd || currentPwd) {
                    // Check current password
                    if (!currentPwd) {
                        $('#currentPasswordError').addClass('show').text('Vui lòng nhập mật khẩu hiện tại');
                        $('#currentPassword').addClass('error');
                        isValid = false;
                    }
                    
                    // Validate new password
                    if (!newPwd) {
                        $('#newPasswordError').addClass('show').text('Vui lòng nhập mật khẩu mới');
                        $('#newPassword').addClass('error');
                        isValid = false;
                    } else {
                        if (newPwd.length < 8) {
                            $('#newPasswordError').addClass('show').text('Mật khẩu phải có ít nhất 8 ký tự');
                            $('#newPassword').addClass('error');
                            isValid = false;
                        } else if (!/[A-Z]/.test(newPwd)) {
                            $('#newPasswordError').addClass('show').text('Mật khẩu phải có ít nhất 1 ký tự viết hoa');
                            $('#newPassword').addClass('error');
                            isValid = false;
                        } else if (!/[0-9]/.test(newPwd)) {
                            $('#newPasswordError').addClass('show').text('Mật khẩu phải có ít nhất 1 chữ số');
                            $('#newPassword').addClass('error');
                            isValid = false;
                        } else if (!/[^A-Za-z0-9]/.test(newPwd)) {
                            $('#newPasswordError').addClass('show').text('Mật khẩu phải có ít nhất 1 ký tự đặc biệt');
                            $('#newPassword').addClass('error');
                            isValid = false;
                        }
                    }
                    
                    // Check confirm password
                    if (newPwd !== confirmPwd) {
                        $('#confirmPasswordError').addClass('show').text('Mật khẩu xác nhận không khớp');
                        $('#confirmPassword').addClass('error');
                        isValid = false;
                    }
                }

                if (!isValid) {
                    // Scroll to first error
                    $('html, body').animate({
                        scrollTop: $('.error-message.show').first().offset().top - 100
                    }, 300);
                    return;
                }

                // Submit via AJAX
                var formData = $('#profileForm').serialize();
                
                // Show loading
                $('#btnSave').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang lưu...');

                $.ajax({
                    url: '@Url.Action("UpdateProfile", "Home65130650", new { area = "Admin" })',
                    type: 'POST',
                    data: formData,
                    dataType: 'json',
                    success: function(response) {
                        $('#btnSave').prop('disabled', false).html('<i class="fas fa-save"></i> Lưu thay đổi');
                        
                        if (response.success) {
                            // Show success message
                            var successAlert = '<div class="alert alert-success"><i class="fas fa-check-circle"></i>' + response.message + '</div>';
                            $('.page-header').after(successAlert);
                            
                            // Update view mode with new data
                            if (response.updatedInfo) {
                                $('#viewMode .info-grid .info-item:nth-child(1) span').text(response.updatedInfo.hoTen);
                                $('#viewMode .info-grid .info-item:nth-child(3) span').text(response.updatedInfo.soDienThoai);
                                $('#viewMode .info-grid .info-item:nth-child(4) span').text(response.updatedInfo.gioiTinh);
                                $('#viewMode .info-grid .info-item:nth-child(5) span').text(response.updatedInfo.ngaySinh);
                                $('#viewMode .info-grid .info-item:nth-child(6) span').text(response.updatedInfo.diaChi);
                                $('#viewMode .info-grid .info-item:nth-child(8) span').text(response.updatedInfo.ngayCapNhat);
                                
                                // Update sidebar
                                $('.profile-sidebar h2').text(response.updatedInfo.hoTen);
                                $('.profile-avatar').text(response.updatedInfo.hoTen.substring(0, 1).toUpperCase());
                            }
                            
                            // Switch back to view mode
                            setTimeout(function() {
                                $('#editMode').hide();
                                $('#viewMode').show();
                                $('#btnEdit').show();
                                
                                // Clear password fields
                                $('#currentPassword, #newPassword, #confirmPassword').val('');
                                $('#passwordRequirements').hide();
                                
                                // Scroll to top
                                $('html, body').animate({ scrollTop: 0 }, 300);
                            }, 1500);
                        } else {
                            // Show specific password error if exists
                            if (response.passwordError) {
                                $('#currentPasswordError').addClass('show').text(response.passwordError);
                                $('#currentPassword').addClass('error');
                                
                                // Scroll to error input
                                $('html, body').animate({ 
                                    scrollTop: $('#currentPassword').offset().top - 150 
                                }, 300);
                            } else if (response.error) {
                                // Only show general errors in alert
                                var errorAlert = '<div class="alert alert-error"><i class="fas fa-exclamation-circle"></i>' + response.error + '</div>';
                                $('.page-header').after(errorAlert);
                                $('html, body').animate({ scrollTop: 0 }, 300);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#btnSave').prop('disabled', false).html('<i class="fas fa-save"></i> Lưu thay đổi');
                        var errorAlert = '<div class="alert alert-error"><i class="fas fa-exclamation-circle"></i>Có lỗi xảy ra khi kết nối đến server</div>';
                        $('.page-header').after(errorAlert);
                        $('html, body').animate({ scrollTop: 0 }, 300);
                    }
                });
            });
        });
    </script>
}
